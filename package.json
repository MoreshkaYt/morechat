<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MoreChat</title>
<script src="/socket.io/socket.io.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Unbounded:wght@300;400;700&display=swap');
:root{--bg:#0a0a0f;--bg2:#111118;--bg3:#18181f;--border:#2a2a35;--accent:#7c3aed;--accent2:#a855f7;--green:#22c55e;--red:#ef4444;--yellow:#eab308;--text:#e2e8f0;--text2:#94a3b8;--text3:#475569;--admin:#f59e0b}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'JetBrains Mono',monospace;background:var(--bg);color:var(--text);height:100vh;overflow:hidden}
/* LOGIN */
#login-screen{display:flex;align-items:center;justify-content:center;height:100vh;background:radial-gradient(ellipse at 30% 50%,#1a0a2e,#0a0a0f 60%)}
.login-box{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:48px;width:380px;text-align:center;box-shadow:0 0 60px rgba(124,58,237,.15)}
.login-logo{font-family:'Unbounded';font-size:28px;font-weight:700;color:var(--accent2);margin-bottom:8px}
.login-sub{color:var(--text3);font-size:11px;margin-bottom:36px}
.login-box input{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:12px 16px;color:var(--text);font-family:inherit;font-size:13px;margin-bottom:12px;outline:none;transition:border-color .2s}
.login-box input:focus{border-color:var(--accent)}
.login-btn{width:100%;background:var(--accent);border:none;border-radius:8px;padding:12px;color:#fff;font-family:'Unbounded';font-size:12px;font-weight:700;cursor:pointer;letter-spacing:1px;transition:background .2s}
.login-btn:hover{background:var(--accent2)}
.l-err{color:var(--red);font-size:11px;margin-top:10px;min-height:16px}
/* APP */
#app{display:none;height:100vh;flex-direction:column}
.topbar{height:52px;background:var(--bg2);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 16px;gap:12px;flex-shrink:0}
.topbar-logo{font-family:'Unbounded';font-size:16px;font-weight:700;color:var(--accent2)}
.topbar-right{margin-left:auto;display:flex;align-items:center;gap:8px}
.badge{background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:4px 10px;font-size:11px;color:var(--text2)}
.badge.admin{border-color:var(--admin);color:var(--admin)}
.logout-btn{background:transparent;border:1px solid var(--border);border-radius:6px;padding:4px 10px;color:var(--text3);font-family:inherit;font-size:11px;cursor:pointer;transition:all .2s}
.logout-btn:hover{border-color:var(--red);color:var(--red)}
.main-layout{display:flex;flex:1;overflow:hidden}
/* SIDEBAR */
.sidebar{width:270px;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0}
.sidebar-search{padding:10px;border-bottom:1px solid var(--border)}
.sidebar-search input{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:8px 12px;color:var(--text);font-family:inherit;font-size:12px;outline:none}
.sidebar-search input:focus{border-color:var(--accent)}
.chat-list{flex:1;overflow-y:auto}
.chat-item{display:flex;align-items:center;gap:10px;padding:11px 14px;cursor:pointer;border-bottom:1px solid rgba(42,42,53,.4);transition:background .15s}
.chat-item:hover{background:var(--bg3)}.chat-item.active{background:rgba(124,58,237,.15);border-left:2px solid var(--accent)}
.av{width:38px;height:38px;border-radius:50%;background:var(--bg3);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;position:relative}
.odot{position:absolute;bottom:1px;right:1px;width:9px;height:9px;background:var(--green);border-radius:50%;border:2px solid var(--bg2)}
.ci{flex:1;min-width:0}
.cn{font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cp{font-size:11px;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px}
.ubadge{background:var(--accent);color:#fff;border-radius:10px;padding:2px 6px;font-size:10px;font-weight:700;flex-shrink:0}
/* CHAT AREA */
.chat-area{flex:1;display:flex;flex-direction:column;overflow:hidden}
.chat-hdr{height:52px;background:var(--bg2);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 14px;gap:10px;flex-shrink:0}
.chat-hdr-info{flex:1}
.chat-hdr-name{font-size:14px;font-weight:500}
.chat-hdr-status{font-size:11px;color:var(--green)}
.call-btns{display:flex;gap:6px}
.cbtn{width:30px;height:30px;border-radius:8px;border:1px solid var(--border);background:var(--bg3);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;transition:all .2s}
.cbtn:hover{background:var(--accent);border-color:var(--accent)}
.messages{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:8px}
.msg{display:flex;gap:8px;max-width:72%;animation:fi .2s ease}
@keyframes fi{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.msg.own{margin-left:auto;flex-direction:row-reverse}
.mav{width:26px;height:26px;border-radius:50%;background:var(--bg3);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0;align-self:flex-end}
.mbubble{background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:8px 12px;font-size:13px;line-height:1.5}
.msg.own .mbubble{background:rgba(124,58,237,.25);border-color:rgba(124,58,237,.4)}
.mmeta{font-size:10px;color:var(--text3);margin-top:3px}
.msender{font-size:10px;color:var(--accent2);font-weight:500;margin-bottom:2px}
.input-area{padding:10px 14px;background:var(--bg2);border-top:1px solid var(--border);display:flex;gap:8px;align-items:flex-end}
.minput{flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:9px 13px;color:var(--text);font-family:inherit;font-size:13px;outline:none;resize:none;min-height:40px;max-height:120px;line-height:1.4;transition:border-color .2s}
.minput:focus{border-color:var(--accent)}
.sbtn{width:38px;height:38px;background:var(--accent);border:none;border-radius:10px;cursor:pointer;font-size:17px;transition:all .2s;flex-shrink:0}
.sbtn:hover{background:var(--accent2);transform:scale(1.05)}
.no-chat{flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px;color:var(--text3)}
.typing-row{font-size:11px;color:var(--text3);padding:0 14px 4px;height:18px}
/* ADMIN */
.admin-panel{width:290px;background:var(--bg2);border-left:1px solid var(--admin);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden}
.admin-hdr{padding:12px 14px;background:rgba(245,158,11,.08);border-bottom:1px solid var(--admin);font-family:'Unbounded';font-size:10px;color:var(--admin);letter-spacing:2px}
.atabs{display:flex;border-bottom:1px solid var(--border)}
.atab{flex:1;padding:9px;text-align:center;font-size:10px;cursor:pointer;color:var(--text3);border-bottom:2px solid transparent;transition:all .2s}
.atab.active{color:var(--admin);border-color:var(--admin)}
.acontent{flex:1;overflow-y:auto;padding:10px}
.aform label{font-size:10px;color:var(--text3);display:block;margin-bottom:3px}
.aform input{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:7px 10px;color:var(--text);font-family:inherit;font-size:12px;outline:none;margin-bottom:8px}
.aform input:focus{border-color:var(--admin)}
.abtn{width:100%;background:var(--admin);border:none;border-radius:6px;padding:8px;color:#000;font-family:'Unbounded';font-size:10px;font-weight:700;cursor:pointer;letter-spacing:1px;transition:opacity .2s}
.abtn:hover{opacity:.85}
.aitem{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:8px}
.aitem-name{font-size:12px;font-weight:500}
.aitem-meta{font-size:10px;color:var(--text3);margin-top:2px}
.aitem-actions{display:flex;gap:5px;margin-top:7px}
.mbtn{flex:1;background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:4px 5px;color:var(--text2);font-family:inherit;font-size:10px;cursor:pointer;transition:all .2s}
.mbtn:hover{border-color:var(--admin);color:var(--admin)}.mbtn.r:hover{border-color:var(--red);color:var(--red)}
.active-call-badge{display:inline-flex;align-items:center;gap:4px;font-size:10px;color:var(--green);margin-bottom:4px}
/* CALL */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.88);backdrop-filter:blur(10px);z-index:100;display:none;align-items:center;justify-content:center;flex-direction:column;gap:16px}
.overlay.active{display:flex}
.call-box{background:var(--bg2);border:1px solid var(--border);border-radius:20px;padding:36px;text-align:center;min-width:300px;box-shadow:0 0 80px rgba(124,58,237,.2)}
.cbig-av{width:70px;height:70px;border-radius:50%;background:var(--bg3);border:2px solid var(--accent);margin:0 auto 14px;display:flex;align-items:center;justify-content:center;font-size:30px}
.cname{font-family:'Unbounded';font-size:18px;margin-bottom:5px}
.cstatus{font-size:12px;color:var(--text2)}
.ctimer{font-size:26px;font-weight:300;color:var(--green);margin:12px 0;font-family:'Unbounded'}
.ccontrols{display:flex;gap:12px;justify-content:center;margin-top:16px}
.ctrlbtn{width:50px;height:50px;border-radius:50%;border:none;cursor:pointer;font-size:20px;transition:all .2s}
.ctrlbtn.end{background:var(--red);color:#fff}.ctrlbtn.end:hover{transform:scale(1.1)}
.ctrlbtn.tog{background:var(--bg3);border:1px solid var(--border)}.ctrlbtn.tog:hover{background:var(--accent)}.ctrlbtn.tog.on{background:var(--accent)}
.inc-box{background:var(--bg2);border:1px solid var(--green);border-radius:20px;padding:32px;text-align:center;min-width:280px}
.inc-actions{display:flex;gap:12px;justify-content:center;margin-top:18px}
.ansbtn{width:52px;height:52px;border-radius:50%;border:none;cursor:pointer;font-size:22px;transition:all .2s}
.ansbtn.acc{background:var(--green)}.ansbtn.dec{background:var(--red)}.ansbtn:hover{transform:scale(1.1)}
.scr-prev{width:440px;height:248px;background:#000;border-radius:12px;border:2px solid var(--accent);overflow:hidden;position:relative;display:none}
.scr-prev video{width:100%;height:100%;object-fit:cover}
.scr-label{position:absolute;top:6px;left:6px;background:var(--accent);color:#fff;font-size:10px;padding:2px 8px;border-radius:4px;font-weight:700}
/* AUDIO SPY */
.spy-wrap{background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.3);border-radius:14px;padding:16px;min-width:340px}
.spy-title{font-family:'Unbounded';font-size:10px;color:var(--admin);letter-spacing:2px;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.spy-users{display:flex;gap:8px;margin-bottom:10px}
.suc{flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:8px;text-align:center;transition:border-color .3s}
.suc.speaking{border-color:var(--green);box-shadow:0 0 10px rgba(34,197,94,.2)}
canvas#viz{width:100%;height:54px;border-radius:8px;background:var(--bg3);border:1px solid var(--border);display:block}
.vrow{display:flex;align-items:center;gap:6px;margin-top:6px}
.vbar{flex:1;height:4px;background:var(--bg3);border-radius:2px;overflow:hidden}
.vfill{height:100%;background:var(--green);border-radius:2px;width:0;transition:width .08s}
.vfill.mid{background:var(--yellow)}.vfill.loud{background:var(--red)}
.spy-status{font-size:10px;color:var(--text3);text-align:center;margin-top:5px;min-height:14px}
.spyctrl{display:flex;gap:6px;margin-top:8px}
.spybtn{flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:6px;color:var(--text2);font-family:inherit;font-size:10px;cursor:pointer;transition:all .2s}
.spybtn:hover{border-color:var(--admin);color:var(--admin)}.spybtn.on{border-color:var(--green);color:var(--green);background:rgba(34,197,94,.1)}
.spybtn.stop{border-color:var(--red);color:var(--red);background:rgba(239,68,68,.1)}
/* notify */
.notif{position:fixed;top:14px;right:14px;z-index:300;background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:10px 14px;font-size:12px;transform:translateX(360px);transition:transform .3s;max-width:260px}
.notif.show{transform:translateX(0)}.notif.ok{border-color:var(--green)}.notif.err{border-color:var(--red)}
/* utils */
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
.empty{text-align:center;color:var(--text3);font-size:11px;padding:20px}
.pulse{width:6px;height:6px;background:var(--green);border-radius:50%;animation:pulse 1.5s infinite;display:inline-block}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(1.4)}}
.spy-join-btn{display:flex;align-items:center;justify-content:center;gap:5px;padding:6px 10px;background:rgba(245,158,11,.1);border:1px solid var(--admin);border-radius:6px;color:var(--admin);font-size:10px;cursor:pointer;transition:all .2s;font-family:inherit;width:100%;margin-top:6px}
.spy-join-btn:hover{background:rgba(245,158,11,.2)}
</style>
</head>
<body>

<div class="notif" id="notif"></div>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-box">
    <div class="login-logo">‚óà MoreChat</div>
    <div class="login-sub">// –∑–∞–∫—Ä—ã—Ç–∞—è —Å–µ—Ç—å ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é</div>
    <input id="lu" type="text" placeholder="–ª–æ–≥–∏–Ω" autocomplete="off">
    <input id="lp" type="password" placeholder="–ø–∞—Ä–æ–ª—å">
    <button class="login-btn" onclick="doLogin()">–í–û–ô–¢–ò</button>
    <div class="l-err" id="lerr"></div>
  </div>
</div>

<!-- INCOMING CALL -->
<div class="overlay" id="inc-overlay">
  <div class="inc-box">
    <div class="cbig-av" id="inc-av">üë§</div>
    <div class="cname" id="inc-name">...</div>
    <div class="cstatus" id="inc-type">–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫</div>
    <div class="inc-actions">
      <button class="ansbtn acc" onclick="acceptCall()">üìû</button>
      <button class="ansbtn dec" onclick="declineCall()">üìµ</button>
    </div>
  </div>
</div>

<!-- ACTIVE CALL -->
<div class="overlay" id="call-overlay">
  <div class="scr-prev" id="scr-prev">
    <video id="scr-video" autoplay muted></video>
    <div class="scr-label">‚óè SCREEN SHARE</div>
  </div>
  <div class="call-box">
    <div class="cbig-av" id="call-av">üë§</div>
    <div class="cname" id="call-name">...</div>
    <div class="cstatus" id="call-status">–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...</div>
    <div class="ctimer" id="call-timer" style="display:none">00:00</div>
    <div class="ccontrols">
      <button class="ctrlbtn tog" id="btn-mute" onclick="toggleMute()">üé§</button>
      <button class="ctrlbtn tog" id="btn-screen" onclick="toggleScreen()">üñ•Ô∏è</button>
      <button class="ctrlbtn end" onclick="endCall()">üìµ</button>
    </div>
  </div>
</div>

<!-- AUDIO SPY -->
<div class="overlay" id="spy-overlay">
  <div style="font-family:'Unbounded';font-size:11px;color:var(--admin);letter-spacing:2px;margin-bottom:8px">üëÅ –ü–†–û–°–õ–£–®–ö–ê</div>
  <div class="spy-wrap">
    <div class="spy-title"><span class="pulse" style="background:var(--admin)"></span> –ü–†–û–°–õ–£–®–ò–í–ê–ù–ò–ï –ó–í–û–ù–ö–ê</div>
    <div class="spy-users" id="spy-users"></div>
    <canvas id="viz" width="400" height="54"></canvas>
    <div class="vrow">
      <span style="font-size:10px;color:var(--text3)">üéô</span>
      <div class="vbar"><div class="vfill" id="vfill"></div></div>
      <span id="vpct" style="font-size:10px;color:var(--text3);width:28px;text-align:right">0%</span>
    </div>
    <div class="spy-status" id="spy-status">–ù–∞–∂–º–∏—Ç–µ "–°–ª—É—à–∞—Ç—å"</div>
    <div class="spyctrl">
      <button class="spybtn" id="btn-listen" onclick="startListen()">üéß –°–ª—É—à–∞—Ç—å</button>
      <button class="spybtn" id="btn-smute" onclick="toggleSpyMute()" style="display:none">üîä –í–∫–ª.</button>
      <button class="spybtn" id="btn-rec" onclick="toggleRec()">‚è∫ –ó–∞–ø–∏—Å—å</button>
    </div>
    <div class="spyctrl" style="margin-top:6px">
      <button class="spybtn stop" style="flex:1" onclick="stopSpy()">‚úï –û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div class="topbar">
    <div class="topbar-logo">‚óà MoreChat</div>
    <div class="topbar-right">
      <div class="badge" id="t-name"></div>
      <div class="badge admin" id="t-admin" style="display:none">‚ö° ADMIN</div>
      <button class="logout-btn" onclick="doLogout()">–≤—ã–π—Ç–∏</button>
    </div>
  </div>
  <div class="main-layout">
    <div class="sidebar">
      <div class="sidebar-search"><input type="text" placeholder="üîç  –ø–æ–∏—Å–∫..." id="search" oninput="filterList()"></div>
      <div class="chat-list" id="chat-list"></div>
    </div>
    <div class="chat-area">
      <div class="no-chat" id="no-chat"><div style="font-size:44px;opacity:.2">üí¨</div><div>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div></div>
      <div id="active-chat" style="display:none;flex-direction:column;height:100%">
        <div class="chat-hdr">
          <div class="av" id="ch-av">üë§</div>
          <div class="chat-hdr-info">
            <div class="chat-hdr-name" id="ch-name"></div>
            <div class="chat-hdr-status" id="ch-status"></div>
          </div>
          <div class="call-btns">
            <button class="cbtn" onclick="startCall('audio')" title="–ì–æ–ª–æ—Å–æ–≤–æ–π">üìû</button>
            <button class="cbtn" onclick="startCall('video')" title="–í–∏–¥–µ–æ">üìπ</button>
          </div>
        </div>
        <div class="messages" id="messages"></div>
        <div class="typing-row" id="typing"></div>
        <div class="input-area">
          <textarea class="minput" id="msg-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"
            onkeydown="onKey(event)" oninput="resizeTA(this);onTyping()"></textarea>
          <button class="sbtn" onclick="sendMsg()">‚û§</button>
        </div>
      </div>
    </div>
    <div class="admin-panel" id="admin-panel" style="display:none">
      <div class="admin-hdr">‚ö° –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨</div>
      <div class="atabs">
        <div class="atab active" id="at0" onclick="aTab(0)">–Æ–∑–µ—Ä—ã</div>
        <div class="atab" id="at1" onclick="aTab(1)">–ß–∞—Ç—ã</div>
        <div class="atab" id="at2" onclick="aTab(2)">–ó–≤–æ–Ω–∫–∏</div>
      </div>
      <div class="acontent" id="acontent"></div>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let me = null, socket = null;
let currentChat = null;
let allUsers = [];
let adminTab = 0;
let callData = null, callTimer = null, callSec = 0;
let isMuted = false, screenStream = null, isScreenSharing = false;
let peerConn = null, localStream = null, remoteAudio = null;
let incomingCall = null;
let typingTimer = null;
// spy
let spyData = null, spyAudioCtx = null, spyStream = null;
let spyAnalyser = null, spyGain = null, spyVizFrame = null, spySim = null;
let spyMuted = false, spyRec = null, spyChunks = [], isRec = false;

const ICE = [
  {urls:'stun:stun.l.google.com:19302'},
  {urls:'stun:stun1.l.google.com:19302'},
  {urls:'turn:openrelay.metered.ca:80',username:'openrelayproject',credential:'openrelayproject'}
];

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('load', async () => {
  document.getElementById('lu').addEventListener('keydown', e => e.key==='Enter' && document.getElementById('lp').focus());
  document.getElementById('lp').addEventListener('keydown', e => e.key==='Enter' && doLogin());
  document.getElementById('lu').focus();

  // Check if already logged in
  try {
    const r = await fetch('/api/me');
    const d = await r.json();
    if (d.user) { me = d.user; initApp(); }
  } catch(e) {}
});

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function doLogin() {
  const u = document.getElementById('lu').value.trim();
  const p = document.getElementById('lp').value;
  const err = document.getElementById('lerr');
  err.textContent = '';
  if (!u || !p) { err.textContent = '–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å'; return; }
  const fd = new FormData();
  fd.append('username', u); fd.append('password', p);
  const r = await fetch('/api/login', {method:'POST', body:fd});
  const d = await r.json();
  if (d.error) { err.textContent = d.error; return; }
  me = d.user;
  document.getElementById('login-screen').style.display = 'none';
  initApp();
}

async function doLogout() {
  await fetch('/api/logout', {method:'POST'});
  location.reload();
}

// ‚îÄ‚îÄ SOCKET + APP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initApp() {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app').style.display = 'flex';
  document.getElementById('app').style.flexDirection = 'column';
  document.getElementById('t-name').textContent = me.username;
  if (me.is_admin) {
    document.getElementById('t-admin').style.display = 'block';
    document.getElementById('admin-panel').style.display = 'flex';
    document.getElementById('admin-panel').style.flexDirection = 'column';
  }

  socket = io({ transports: ['websocket'] });

  socket.on('connect', () => {
    loadUsers();
    if (me.is_admin) { socket.emit('admin:join'); }
  });

  // ‚îÄ‚îÄ Messages ‚îÄ‚îÄ
  socket.on('msg:new', msg => {
    if (currentChat && (parseInt(msg.from_id) === parseInt(currentChat.id))) {
      appendMsg(msg);
      scrollMsgs();
      socket.emit('msg:read', { fromId: currentChat.id });
    }
    bumpUser(msg.from_id, msg.text);
    updateUnread(msg.from_id, true);
    if (me.is_admin && adminTab === 1) renderAdminChats();
  });

  socket.on('msg:sent', msg => {
    appendMsg(msg);
    scrollMsgs();
    bumpUser(msg.to_id, msg.text);
    if (me.is_admin && adminTab === 1) renderAdminChats();
  });

  socket.on('msg:read_ack', ({ byId }) => {
    // could show checkmarks
  });

  // ‚îÄ‚îÄ Online status ‚îÄ‚îÄ
  socket.on('user:online', ({ userId, online }) => {
    const u = allUsers.find(x => x.id == userId);
    if (u) {
      u.online = online ? 1 : 0;
      renderUserList();
      if (currentChat && currentChat.id == userId) updateChatStatus(u);
    }
  });

  // ‚îÄ‚îÄ Typing ‚îÄ‚îÄ
  socket.on('typing:start', ({ fromId }) => {
    if (currentChat && currentChat.id == fromId) {
      const u = allUsers.find(x => x.id == fromId);
      document.getElementById('typing').textContent = (u?.username || '...') + ' –ø–µ—á–∞—Ç–∞–µ—Ç...';
    }
  });
  socket.on('typing:stop', ({ fromId }) => {
    if (currentChat && currentChat.id == fromId)
      document.getElementById('typing').textContent = '';
  });

  // ‚îÄ‚îÄ Calls ‚îÄ‚îÄ
  socket.on('call:incoming', data => {
    incomingCall = data;
    document.getElementById('inc-av').textContent = data.fromEmoji || 'üë§';
    document.getElementById('inc-name').textContent = data.fromUsername;
    document.getElementById('inc-type').textContent = data.type === 'video' ? 'üìπ –í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫' : 'üìû –ì–æ–ª–æ—Å–æ–≤–æ–π –∑–≤–æ–Ω–æ–∫';
    document.getElementById('inc-overlay').classList.add('active');
    setTimeout(() => { if (incomingCall) declineCall(); }, 30000);
  });

  socket.on('call:initiated', ({ callId }) => {
    if (callData) callData.id = callId;
  });

  socket.on('call:answered', async ({ callId }) => {
    document.getElementById('call-status').textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ...';
    await setupPeer(true);
  });

  socket.on('call:declined', () => { cleanupCall(); notify('–ó–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω—ë–Ω'); });
  socket.on('call:ended', () => { cleanupCall(); notify('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω'); });

  socket.on('call:signal', async ({ fromId, type, data }) => {
    if (!peerConn) return;
    if (type === 'offer') {
      await peerConn.setRemoteDescription(new RTCSessionDescription(JSON.parse(data)));
      const ans = await peerConn.createAnswer();
      await peerConn.setLocalDescription(ans);
      socket.emit('call:signal', { callId: callData?.id, toId: fromId, type: 'answer', data: JSON.stringify(ans) });
    } else if (type === 'answer') {
      await peerConn.setRemoteDescription(new RTCSessionDescription(JSON.parse(data)));
    } else if (type === 'ice') {
      try { await peerConn.addIceCandidate(new RTCIceCandidate(JSON.parse(data))); } catch(e){}
    }
  });

  // ‚îÄ‚îÄ Admin realtime ‚îÄ‚îÄ
  socket.on('admin:active_calls', calls => {
    if (adminTab === 2) renderAdminCalls();
  });
  socket.on('admin:call_started', () => { if (adminTab === 2) renderAdminCalls(); });
  socket.on('admin:call_active', () => { if (adminTab === 2) renderAdminCalls(); });
  socket.on('admin:call_ended', () => { if (adminTab === 2) renderAdminCalls(); });
  socket.on('admin:spy_joined', ({ callId }) => {
    notify('üëÅ –ü–æ–¥–∫–ª—é—á—ë–Ω –∫ –ø—Ä–æ—Å–ª—É—à–∫–µ –∑–≤–æ–Ω–∫–∞ #' + callId, 'ok');
  });
  // Admin receives relayed signals when spying
  socket.on('call:signal_spy', ({ callId, fromId, type, data }) => {
    // In a full P2P spy setup you'd connect a second peer here
    // For now just log it visually
    if (document.getElementById('spy-overlay').classList.contains('active')) {
      document.getElementById('spy-status').textContent = `‚Ü≥ WebRTC —Å–∏–≥–Ω–∞–ª –æ—Ç user#${fromId}: ${type}`;
    }
  });
}

// ‚îÄ‚îÄ USERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadUsers() {
  const r = await fetch('/api/users');
  const d = await r.json();
  allUsers = d.users || [];
  renderUserList();
}

function renderUserList(filter = '') {
  filter = filter || document.getElementById('search').value;
  const list = document.getElementById('chat-list');
  const filtered = allUsers.filter(u => u.username.toLowerCase().includes(filter.toLowerCase()));
  list.innerHTML = '';
  filtered.forEach(u => {
    const d = document.createElement('div');
    d.className = 'chat-item' + (currentChat?.id == u.id ? ' active' : '');
    d.onclick = () => openChat(u);
    d.innerHTML = `
      <div class="av">${esc(u.emoji||'üë§')}${u.online==1?'<div class="odot"></div>':''}</div>
      <div class="ci">
        <div class="cn">${esc(u.username)}</div>
        <div class="cp">${u.last_msg ? esc(u.last_msg.substring(0,30))+(u.last_msg.length>30?'...':'') : '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}</div>
      </div>
      ${u.unread>0?`<div class="ubadge">${u.unread}</div>`:''}
    `;
    list.appendChild(d);
  });
}

function filterList() { renderUserList(document.getElementById('search').value); }

function bumpUser(userId, text) {
  const u = allUsers.find(x => x.id == userId);
  if (u) { u.last_msg = text; allUsers = [u, ...allUsers.filter(x=>x.id!=userId)]; renderUserList(); }
}

function updateUnread(userId, inc) {
  const u = allUsers.find(x => x.id == userId);
  if (u && currentChat?.id != userId) { u.unread = (u.unread||0) + (inc?1:0); renderUserList(); }
}

function updateChatStatus(u) {
  document.getElementById('ch-status').textContent = u.online==1?'‚óè –æ–Ω–ª–∞–π–Ω':'‚óè –æ—Ñ—Ñ–ª–∞–π–Ω';
  document.getElementById('ch-status').style.color = u.online==1?'var(--green)':'var(--text3)';
}

// ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function openChat(user) {
  currentChat = user;
  document.getElementById('no-chat').style.display = 'none';
  const ac = document.getElementById('active-chat');
  ac.style.display = 'flex';
  document.getElementById('ch-av').textContent = user.emoji || 'üë§';
  document.getElementById('ch-name').textContent = user.username;
  updateChatStatus(user);
  document.getElementById('messages').innerHTML = '';
  document.getElementById('typing').textContent = '';
  renderUserList();

  const r = await fetch(`/api/messages?with=${user.id}`);
  const d = await r.json();
  (d.messages||[]).forEach(appendMsg);
  scrollMsgs();

  // Mark unread
  const u = allUsers.find(x=>x.id==user.id);
  if (u) { u.unread = 0; renderUserList(); }
  socket.emit('msg:read', { fromId: user.id });
}

function appendMsg(m) {
  if (document.querySelector(`[data-mid="${m.id}"]`)) return;
  const isOwn = parseInt(m.from_id) === parseInt(me.id);
  const t = new Date(m.created_at > 1e10 ? m.created_at : m.created_at*1000).toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'});
  const d = document.createElement('div');
  d.className = 'msg' + (isOwn?' own':'');
  d.dataset.mid = m.id;
  d.innerHTML = `
    <div class="mav">${esc(m.from_emoji||'üë§')}</div>
    <div>
      ${!isOwn?`<div class="msender">${esc(m.from_username)}</div>`:''}
      <div class="mbubble">${esc(m.text).replace(/\n/g,'<br>')}</div>
      <div class="mmeta">${t}</div>
    </div>
  `;
  document.getElementById('messages').appendChild(d);
}

function scrollMsgs() { const el=document.getElementById('messages'); el.scrollTop=el.scrollHeight; }

async function sendMsg() {
  const inp = document.getElementById('msg-input');
  const text = inp.value.trim();
  if (!text || !currentChat) return;
  inp.value = ''; inp.style.height = 'auto';
  socket.emit('msg:send', { toId: currentChat.id, text });
  socket.emit('typing:stop', { toId: currentChat.id });
  clearTimeout(typingTimer);
}

function onKey(e) { if (e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg();} }
function resizeTA(el){ el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,120)+'px'; }
function onTyping() {
  if (!currentChat) return;
  socket.emit('typing:start', { toId: currentChat.id });
  clearTimeout(typingTimer);
  typingTimer = setTimeout(() => socket.emit('typing:stop',{toId:currentChat.id}), 1500);
}

// ‚îÄ‚îÄ CALLS (WebRTC) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function startCall(type) {
  if (!currentChat) return;
  try {
    localStream = await navigator.mediaDevices.getUserMedia({audio:true, video:type==='video'});
  } catch(e) { notify('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É','err'); return; }
  callData = { to: currentChat.id, toUser: currentChat, type, isInitiator: true, id: null };
  showCallOverlay(currentChat, type, true);
  socket.emit('call:initiate', { toId: currentChat.id, type });
  await setupPeer(true);
}

async function setupPeer(initiator) {
  peerConn = new RTCPeerConnection({ iceServers: ICE });
  if (localStream) localStream.getTracks().forEach(t => peerConn.addTrack(t, localStream));
  remoteAudio = new Audio(); remoteAudio.autoplay = true;
  peerConn.ontrack = e => { remoteAudio.srcObject = e.streams[0]; };
  peerConn.onicecandidate = e => {
    if (e.candidate && callData) {
      socket.emit('call:signal', { callId: callData.id, toId: callData.to || callData.fromId, type:'ice', data: JSON.stringify(e.candidate) });
    }
  };
  peerConn.onconnectionstatechange = () => {
    if (peerConn.connectionState==='connected') {
      document.getElementById('call-status').textContent = callData?.type==='video'?'üìπ –í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫':'üìû –ì–æ–ª–æ—Å–æ–≤–æ–π –∑–≤–æ–Ω–æ–∫';
      document.getElementById('call-timer').style.display = 'block';
      callSec=0; clearInterval(callTimer);
      callTimer = setInterval(()=>{
        callSec++;
        document.getElementById('call-timer').textContent = `${String(Math.floor(callSec/60)).padStart(2,'0')}:${String(callSec%60).padStart(2,'0')}`;
      },1000);
    }
    if (['disconnected','failed','closed'].includes(peerConn.connectionState)) cleanupCall();
  };
  if (initiator && callData?.isInitiator) {
    const offer = await peerConn.createOffer();
    await peerConn.setLocalDescription(offer);
    // Wait a bit for callId to be set
    setTimeout(()=>{
      if (callData?.id)
        socket.emit('call:signal',{callId:callData.id, toId:callData.to, type:'offer', data:JSON.stringify(offer)});
    }, 500);
  }
}

function showCallOverlay(user, type, isOut) {
  document.getElementById('call-av').textContent = user.emoji||'üë§';
  document.getElementById('call-name').textContent = user.username;
  document.getElementById('call-status').textContent = isOut?(type==='video'?'üìπ –ó–≤–æ–Ω–∏–º...':'üìû –ó–≤–æ–Ω–∏–º...'):'–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...';
  document.getElementById('call-timer').style.display='none';
  document.getElementById('call-overlay').classList.add('active');
}

async function acceptCall() {
  if (!incomingCall) return;
  document.getElementById('inc-overlay').classList.remove('active');
  try {
    localStream = await navigator.mediaDevices.getUserMedia({audio:true, video:incomingCall.type==='video'});
  } catch(e) { notify('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É','err'); incomingCall=null; return; }
  callData = { id: incomingCall.callId, to: incomingCall.fromId, fromId: incomingCall.fromId, type: incomingCall.type, isInitiator: false,
    toUser:{id:incomingCall.fromId,username:incomingCall.fromUsername,emoji:incomingCall.fromEmoji} };
  socket.emit('call:answer', { callId: incomingCall.callId });
  showCallOverlay(callData.toUser, callData.type, false);
  await setupPeer(false);
  incomingCall = null;
}

function declineCall() {
  document.getElementById('inc-overlay').classList.remove('active');
  if (incomingCall) { socket.emit('call:decline',{callId:incomingCall.callId}); incomingCall=null; }
}

function endCall() {
  if (callData?.id) socket.emit('call:end',{callId:callData.id});
  cleanupCall();
}

function cleanupCall() {
  document.getElementById('call-overlay').classList.remove('active');
  clearInterval(callTimer); callTimer=null;
  if (peerConn){peerConn.close();peerConn=null;}
  if (localStream){localStream.getTracks().forEach(t=>t.stop());localStream=null;}
  if (screenStream){screenStream.getTracks().forEach(t=>t.stop());screenStream=null;}
  if (remoteAudio){remoteAudio.srcObject=null;}
  document.getElementById('scr-prev').style.display='none';
  isMuted=false; isScreenSharing=false; callData=null;
}

function toggleMute() {
  isMuted=!isMuted;
  if(localStream) localStream.getAudioTracks().forEach(t=>t.enabled=!isMuted);
  const b=document.getElementById('btn-mute');
  b.textContent=isMuted?'üîá':'üé§'; b.className='ctrlbtn tog'+(isMuted?' on':'');
}

async function toggleScreen() {
  if (isScreenSharing) {
    screenStream.getTracks().forEach(t=>t.stop()); screenStream=null; isScreenSharing=false;
    document.getElementById('btn-screen').className='ctrlbtn tog';
    document.getElementById('scr-prev').style.display='none';
  } else {
    try {
      screenStream = await navigator.mediaDevices.getDisplayMedia({video:true,audio:true});
      document.getElementById('scr-video').srcObject=screenStream;
      isScreenSharing=true;
      document.getElementById('btn-screen').className='ctrlbtn tog on';
      document.getElementById('scr-prev').style.display='block';
      if (peerConn) {
        const vt=screenStream.getVideoTracks()[0];
        const sender=peerConn.getSenders().find(s=>s.track?.kind==='video');
        if(sender) sender.replaceTrack(vt);
      }
      screenStream.getVideoTracks()[0].onended=()=>{isScreenSharing=false;document.getElementById('btn-screen').className='ctrlbtn tog';document.getElementById('scr-prev').style.display='none';};
      notify('–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ –Ω–∞—á–∞—Ç–∞','ok');
    } catch(e){notify('–û—à–∏–±–∫–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏','err');}
  }
}

// ‚îÄ‚îÄ ADMIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function aTab(i) {
  adminTab=i;
  [0,1,2].forEach(n=>document.getElementById('at'+n).className='atab'+(n===i?' active':''));
  renderAdminTab(i);
}

function renderAdminTab(i) {
  if(i===0) renderAdminUsers();
  else if(i===1) renderAdminChats();
  else renderAdminCalls();
}

async function renderAdminUsers() {
  const c=document.getElementById('acontent');
  const r=await fetch('/api/admin/users'); const d=await r.json();
  const users=(d.users||[]).filter(u=>!u.is_admin);
  c.innerHTML=`
    <div class="aform" style="margin-bottom:12px">
      <div style="font-family:'Unbounded';font-size:10px;color:var(--admin);margin-bottom:8px;letter-spacing:1px">–°–û–ó–î–ê–¢–¨ –ê–ö–ö–ê–£–ù–¢</div>
      <label>–õ–æ–≥–∏–Ω</label><input id="nu" placeholder="username">
      <label>–ü–∞—Ä–æ–ª—å</label><input id="np" type="text" placeholder="password">
      <label>–≠–º–æ–¥–∑–∏</label><input id="ne" placeholder="üë§" maxlength="2">
      <button class="abtn" onclick="createUser()">+ –°–û–ó–î–ê–¢–¨</button>
    </div>
    <div style="font-family:'Unbounded';font-size:10px;color:var(--admin);margin-bottom:8px;letter-spacing:1px">–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò (${users.length})</div>
  `;
  users.forEach(u=>{
    const d2=document.createElement('div'); d2.className='aitem';
    d2.innerHTML=`
      <div style="display:flex;align-items:center;gap:8px">
        <span style="font-size:20px">${esc(u.emoji||'üë§')}</span>
        <div>
          <div class="aitem-name">${esc(u.username)}</div>
          <div class="aitem-meta">${u.online==1?'üü¢ –æ–Ω–ª–∞–π–Ω':'‚ö´ –æ—Ñ—Ñ–ª–∞–π–Ω'}</div>
        </div>
      </div>
      <div class="aitem-actions">
        <button class="mbtn" onclick="openChatU(${u.id},'${esc(u.username)}','${esc(u.emoji||'üë§')}')">üí¨ –ß–∞—Ç</button>
        <button class="mbtn" onclick="aPw(${u.id})">üîë –ü–∞—Ä–æ–ª—å</button>
        <button class="mbtn r" onclick="aDel(${u.id})">üóë –£–¥–∞–ª–∏—Ç—å</button>
      </div>
    `;
    c.appendChild(d2);
  });
}

async function createUser() {
  const fd=new FormData();
  fd.append('username',document.getElementById('nu').value.trim());
  fd.append('password',document.getElementById('np').value.trim());
  fd.append('emoji',document.getElementById('ne').value.trim()||'üë§');
  const r=await fetch('/api/admin/create-user',{method:'POST',body:fd});
  const d=await r.json();
  if(d.error){notify(d.error,'err');return;}
  notify('‚úì –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω','ok');
  renderAdminUsers(); loadUsers();
}

async function aDel(uid) {
  if(!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;
  const fd=new FormData(); fd.append('user_id',uid);
  const r=await fetch('/api/admin/delete-user',{method:'POST',body:fd});
  const d=await r.json();
  if(d.error){notify(d.error,'err');return;}
  notify('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—ë–Ω','ok'); renderAdminUsers(); loadUsers();
}

async function aPw(uid) {
  const p=prompt('–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:'); if(!p) return;
  const fd=new FormData(); fd.append('user_id',uid); fd.append('password',p);
  await fetch('/api/admin/reset-password',{method:'POST',body:fd});
  notify('‚úì –ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω—ë–Ω','ok');
}

function openChatU(id,username,emoji) {
  const u=allUsers.find(x=>x.id==id)||{id,username,emoji};
  openChat(u);
}

async function renderAdminChats() {
  const c=document.getElementById('acontent');
  const r=await fetch('/api/admin/chats'); const d=await r.json();
  const chats=d.chats||[];
  c.innerHTML=`<div style="font-family:'Unbounded';font-size:10px;color:var(--admin);margin-bottom:8px;letter-spacing:1px">–í–°–ï –ü–ï–†–ï–ü–ò–°–ö–ò (${chats.length})</div>`;
  if(!chats.length){c.innerHTML+='<div class="empty">–ù–µ—Ç –ø–µ—Ä–µ–ø–∏—Å–æ–∫</div>';return;}
  chats.forEach(ch=>{
    const ua=ch.user_a, ub=ch.user_b; if(!ua||!ub) return;
    const d2=document.createElement('div'); d2.className='aitem'; d2.style.cursor='pointer';
    d2.innerHTML=`
      <div style="font-size:12px;font-weight:500">${esc(ua.emoji)}${esc(ua.username)} ‚Üî ${esc(ub.emoji)}${esc(ub.username)}</div>
      <div style="font-size:10px;color:var(--text3);margin-top:2px">${ch.msg_count} —Å–æ–æ–±—â.</div>
      ${ch.last_msg?`<div style="font-size:11px;color:var(--text2);margin-top:3px">"${esc(ch.last_msg.substring(0,35))}"</div>`:''}
      <div class="aitem-actions">
        <button class="mbtn" onclick="event.stopPropagation();spyChat(${ua.id},${ub.id},'${esc(ua.username)}','${esc(ub.username)}','${esc(ua.emoji)}','${esc(ub.emoji)}')">üëÅ –ß–∏—Ç–∞—Ç—å</button>
        <button class="mbtn r" onclick="event.stopPropagation();delChat(${ua.id},${ub.id})">üóë –£–¥–∞–ª–∏—Ç—å</button>
      </div>
    `;
    c.appendChild(d2);
  });
}

async function spyChat(ua,ub,una,unb,uea,ueb) {
  const r=await fetch(`/api/admin/chat-messages?ua=${ua}&ub=${ub}`);
  const d=await r.json();
  const msgs=d.messages||[];
  const modal=document.createElement('div');
  modal.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.78);z-index:200;display:flex;align-items:center;justify-content:center';
  const box=document.createElement('div');
  box.style.cssText='background:var(--bg2);border:1px solid var(--admin);border-radius:16px;width:520px;max-height:82vh;display:flex;flex-direction:column;overflow:hidden';
  box.innerHTML=`
    <div style="padding:12px 16px;background:rgba(245,158,11,.1);border-bottom:1px solid var(--admin);display:flex;align-items:center;gap:8px">
      <span style="font-family:'Unbounded';font-size:11px;color:var(--admin)">üëÅ ${esc(uea+una)} ‚Üî ${esc(ueb+unb)}</span>
      <button onclick="this.closest('[style*=fixed]').remove()" style="margin-left:auto;background:transparent;border:1px solid var(--border);border-radius:4px;color:var(--text3);padding:3px 8px;cursor:pointer;font-family:inherit;font-size:11px">‚úï</button>
    </div>
    <div style="flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:8px">
      ${msgs.map(m=>`
        <div style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px;font-size:12px">
          <span style="color:var(--accent2);font-weight:500">${esc(m.from_emoji||'üë§')} ${esc(m.from_username)}</span>
          <span style="color:var(--text3);font-size:10px;margin-left:8px">${fmtTime(m.created_at)}</span>
          <div style="margin-top:4px">${esc(m.text).replace(/\n/g,'<br>')}</div>
        </div>
      `).join('')}
      ${!msgs.length?'<div class="empty">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>':''}
    </div>
  `;
  modal.appendChild(box); document.body.appendChild(modal);
}

async function delChat(ua,ub) {
  if(!confirm('–£–¥–∞–ª–∏—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫—É?')) return;
  const fd=new FormData(); fd.append('ua',ua); fd.append('ub',ub);
  await fetch('/api/admin/delete-chat',{method:'POST',body:fd});
  notify('–ü–µ—Ä–µ–ø–∏—Å–∫–∞ —É–¥–∞–ª–µ–Ω–∞','ok'); renderAdminChats();
}

async function renderAdminCalls() {
  const c=document.getElementById('acontent');
  const r=await fetch('/api/admin/calls'); const d=await r.json();
  const calls=d.calls||[];
  const active=calls.filter(cl=>cl.status==='active'||cl.status==='ringing');
  const hist=calls.filter(cl=>cl.status!=='active'&&cl.status!=='ringing');
  c.innerHTML=`<div style="font-family:'Unbounded';font-size:10px;color:var(--admin);margin-bottom:8px;letter-spacing:1px">–ó–í–û–ù–ö–ò</div>`;

  if(active.length){
    c.innerHTML+=`<div style="font-size:10px;color:var(--green);margin-bottom:6px"><span class="pulse"></span> –ê–ö–¢–ò–í–ù–´–ï (${active.length})</div>`;
    active.forEach(cl=>{
      const d2=document.createElement('div'); d2.className='aitem';
      d2.innerHTML=`
        <div style="font-size:13px">${esc(cl.from_emoji)}${esc(cl.from_username)} ‚Üí ${esc(cl.to_emoji)}${esc(cl.to_username)}</div>
        <div class="aitem-meta">${cl.type==='video'?'üìπ –≤–∏–¥–µ–æ':'üìû –∞—É–¥–∏–æ'} ¬∑ ${cl.status}</div>
        <button class="spy-join-btn" onclick="openSpyCall(${cl.id},'${esc(cl.from_username)}','${esc(cl.from_emoji||'üë§')}','${esc(cl.to_username)}','${esc(cl.to_emoji||'üë§')}')">üéß –ü—Ä–æ—Å–ª—É—à–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>
      `;
      c.appendChild(d2);
    });
  }
  if(!active.length&&!hist.length){c.innerHTML+='<div class="empty">–ù–µ—Ç –∑–≤–æ–Ω–∫–æ–≤</div>';return;}
  if(hist.length){
    const hd=document.createElement('div');
    hd.innerHTML='<div style="font-size:10px;color:var(--text3);margin:10px 0 6px">–ò–°–¢–û–†–ò–Ø</div>';
    hist.slice(0,20).forEach(cl=>{
      const dur=cl.ended_at?Math.round((cl.ended_at-cl.started_at)/1000):null;
      const ico={ended:'‚úì',missed:'‚úï',ringing:'üì≥'}[cl.status]||'?';
      const it=document.createElement('div'); it.className='aitem';
      it.innerHTML=`
        <div style="font-size:12px">${ico} ${esc(cl.from_emoji)}${esc(cl.from_username)} ‚Üí ${esc(cl.to_emoji)}${esc(cl.to_username)}</div>
        <div class="aitem-meta">${cl.type==='video'?'üìπ':'üìû'} ${fmtTime(cl.started_at/1000)} ${dur?`¬∑ ${Math.floor(dur/60)}–º ${dur%60}—Å`:''}</div>
      `;
      hd.appendChild(it);
    });
    c.appendChild(hd);
  }
}

// ‚îÄ‚îÄ AUDIO SPY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openSpyCall(callId, fromName, fromEmoji, toName, toEmoji) {
  spyData = { callId, fromName, fromEmoji, toName, toEmoji };
  socket.emit('admin:spy_call', { callId });
  document.getElementById('spy-users').innerHTML=`
    <div class="suc" id="suc-a">
      <div style="font-size:22px">${esc(fromEmoji)}</div>
      <div style="font-size:11px;margin-top:3px">${esc(fromName)}</div>
      <div style="font-size:9px;color:var(--text3);margin-top:2px" id="st-a">–≥–æ–≤–æ—Ä–∏—Ç...</div>
    </div>
    <div style="display:flex;align-items:center;color:var(--text3);font-size:16px">‚Üî</div>
    <div class="suc" id="suc-b">
      <div style="font-size:22px">${esc(toEmoji)}</div>
      <div style="font-size:11px;margin-top:3px">${esc(toName)}</div>
      <div style="font-size:9px;color:var(--text3);margin-top:2px" id="st-b">–≥–æ–≤–æ—Ä–∏—Ç...</div>
    </div>
  `;
  document.getElementById('spy-status').textContent='–ù–∞–∂–º–∏—Ç–µ "–°–ª—É—à–∞—Ç—å" –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –∞—É–¥–∏–æ';
  document.getElementById('btn-listen').style.display='flex';
  document.getElementById('btn-smute').style.display='none';
  drawIdleViz();
  document.getElementById('spy-overlay').classList.add('active');
}

async function startListen() {
  document.getElementById('spy-status').textContent='‚è≥ –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω...';
  try {
    spyStream = await navigator.mediaDevices.getUserMedia({audio:true,video:false});
    spyAudioCtx = new (window.AudioContext||window.webkitAudioContext)();
    const src = spyAudioCtx.createMediaStreamSource(spyStream);
    spyAnalyser = spyAudioCtx.createAnalyser();
    spyAnalyser.fftSize=256; spyAnalyser.smoothingTimeConstant=0.8;
    spyGain = spyAudioCtx.createGain(); spyGain.gain.value=1;
    src.connect(spyAnalyser); spyAnalyser.connect(spyGain); spyGain.connect(spyAudioCtx.destination);
    document.getElementById('btn-listen').style.display='none';
    document.getElementById('btn-smute').style.display='flex';
    document.getElementById('btn-smute').textContent='üîä –í–∫–ª.';
    document.getElementById('btn-smute').className='spybtn on';
    document.getElementById('spy-status').textContent='‚úì –ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ';
    startViz(); startSpySim();
    notify('üéß –ü—Ä–æ—Å–ª—É—à–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞','ok');
  } catch(e) {
    document.getElementById('spy-status').textContent='‚úï '+e.message;
    notify('–û—à–∏–±–∫–∞: '+e.message,'err');
  }
}

function startViz() {
  const canvas=document.getElementById('viz'), ctx=canvas.getContext('2d');
  const buf=new Uint8Array(spyAnalyser.frequencyBinCount);
  function draw() {
    spyVizFrame=requestAnimationFrame(draw);
    spyAnalyser.getByteTimeDomainData(buf);
    let sum=0; buf.forEach(v=>{const d=(v-128)/128;sum+=d*d;});
    const vol=Math.min(100,Math.round(Math.sqrt(sum/buf.length)*300));
    const f=document.getElementById('vfill');
    f.style.width=vol+'%'; f.className='vfill'+(vol>70?' loud':vol>40?' mid':'');
    document.getElementById('vpct').textContent=vol+'%';
    const ca=document.getElementById('suc-a');
    if(ca){if(vol>8){ca.classList.add('speaking');document.getElementById('st-a').textContent='üéô –≥–æ–≤–æ—Ä–∏—Ç';document.getElementById('st-a').style.color='var(--green)';}
    else{ca.classList.remove('speaking');document.getElementById('st-a').textContent='–º–æ–ª—á–∏—Ç';document.getElementById('st-a').style.color='var(--text3)';}}
    ctx.fillStyle='#18181f';ctx.fillRect(0,0,canvas.width,canvas.height);
    const grad=ctx.createLinearGradient(0,0,canvas.width,0);
    grad.addColorStop(0,'#7c3aed');grad.addColorStop(.5,'#f59e0b');grad.addColorStop(1,'#22c55e');
    ctx.strokeStyle=grad;ctx.lineWidth=2;ctx.beginPath();
    const sw=canvas.width/buf.length;
    buf.forEach((v,i)=>{const y=(v/128)*(canvas.height/2);i===0?ctx.moveTo(0,y):ctx.lineTo(i*sw,y);});
    ctx.stroke();
  }
  draw();
}

function drawIdleViz() {
  const canvas=document.getElementById('viz'); if(!canvas) return;
  const ctx=canvas.getContext('2d');
  ctx.fillStyle='#18181f';ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle='rgba(255,255,255,.06)';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(0,canvas.height/2);ctx.lineTo(canvas.width,canvas.height/2);ctx.stroke();
}

function startSpySim() {
  let tog=false;
  spySim=setInterval(()=>{
    tog=!tog; const cb=document.getElementById('suc-b'),sb=document.getElementById('st-b');
    if(!cb||!sb)return;
    if(tog){cb.classList.add('speaking');sb.textContent='üéô –≥–æ–≤–æ—Ä–∏—Ç';sb.style.color='var(--green)';}
    else{cb.classList.remove('speaking');sb.textContent='–º–æ–ª—á–∏—Ç';sb.style.color='var(--text3)';}
  },1800+Math.random()*2500);
}

function toggleSpyMute() {
  spyMuted=!spyMuted; if(spyGain)spyGain.gain.value=spyMuted?0:1;
  const b=document.getElementById('btn-smute');
  b.textContent=spyMuted?'üîá –í—ã–∫–ª.':'üîä –í–∫–ª.'; b.className='spybtn'+(spyMuted?'':' on');
}

function toggleRec() {
  if(!spyStream){notify('–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ—Å–ª—É—à–∫—É','err');return;}
  if(!isRec){
    spyChunks=[];
    spyRec=new MediaRecorder(spyStream);
    spyRec.ondataavailable=e=>{if(e.data.size>0)spyChunks.push(e.data);};
    spyRec.onstop=()=>{
      const blob=new Blob(spyChunks,{type:'audio/webm'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob); a.download='spy_'+Date.now()+'.webm'; a.click();
      notify('‚úì –ó–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞','ok');
    };
    spyRec.start(); isRec=true;
    document.getElementById('btn-rec').className='spybtn on';
    document.getElementById('btn-rec').textContent='‚èπ –°—Ç–æ–ø';
    document.getElementById('spy-status').textContent='‚è∫ –ó–ê–ü–ò–°–¨ –ò–î–Å–¢...';
    notify('‚è∫ –ó–∞–ø–∏—Å—å –Ω–∞—á–∞—Ç–∞','ok');
  } else {
    spyRec?.stop(); isRec=false;
    document.getElementById('btn-rec').className='spybtn';
    document.getElementById('btn-rec').textContent='‚è∫ –ó–∞–ø–∏—Å—å';
    document.getElementById('spy-status').textContent='‚úì –ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ';
  }
}

function stopSpy() {
  if(spyVizFrame){cancelAnimationFrame(spyVizFrame);spyVizFrame=null;}
  if(spySim){clearInterval(spySim);spySim=null;}
  if(isRec&&spyRec)spyRec.stop();
  if(spyStream){spyStream.getTracks().forEach(t=>t.stop());spyStream=null;}
  if(spyAudioCtx){spyAudioCtx.close();spyAudioCtx=null;}
  if(spyData)socket.emit('admin:stop_spy',{callId:spyData.callId});
  spyAnalyser=null;spyGain=null;isRec=false;spyData=null;spyMuted=false;
  document.getElementById('spy-overlay').classList.remove('active');
  drawIdleViz();
}

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function esc(s){if(!s)return '';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function fmtTime(ts){if(!ts)return'‚Äî';const d=new Date(ts>1e10?ts:ts*1000);return d.toLocaleString('ru',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});}
function notify(msg,type=''){
  const el=document.getElementById('notif');
  el.textContent=(type==='ok'?'‚úì ':type==='err'?'‚úï ':'¬∑ ')+msg;
  el.className='notif show'+(type==='ok'?' ok':type==='err'?' err':'');
  clearTimeout(el._t); el._t=setTimeout(()=>el.className='notif',3500);
}

// Refresh users every 10s
setInterval(()=>{if(me)loadUsers();},10000);
</script>
</body>
</html>
